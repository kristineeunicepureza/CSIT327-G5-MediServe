{% extends 'base.html' %}
{% load static %}

{% block title %}Barangay Announcements{% endblock %}

{% block content %}

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
/* ———————– MAIN CONTAINER ———————– */
.announcements-container {
    width: 100%;
    max-width: 1400px;
    margin: 40px auto;
    background: #ffffff;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
}

/* ———————– HEADER ———————– */
.announcements-header {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    padding: 30px 40px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: relative;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 15px;
}

.back-button {
    padding: 12px;
    background-color: rgba(255,255,255,0.2);
    border-radius: 12px;
    color: #fff;
    width: 48px;
    height: 48px;
    display:flex;
    justify-content:center;
    align-items:center;
    border: 2px solid rgba(255,255,255,0.3);
    text-decoration: none;
}

.header-title {
    font-size: 1.8rem;
    font-weight: 700;
    color: #fff;
}

/* ———————– BUTTONS ———————– */
.red-btn, .green-btn, .gray-btn {
    padding: 14px 22px;
    border-radius: 12px;
    color: #fff;
    font-weight: 600;
    cursor: pointer;
    border: none;
    display:flex;
    align-items:center;
    gap: 8px;
    transition: all .3s ease;
    text-decoration: none;
}

.green-btn { background: linear-gradient(135deg, #28a745, #20c997); }
.gray-btn { background: linear-gradient(135deg, #6c757d, #495057); }

/* ———————– ANNOUNCEMENT CARDS ———————– */
.announcement-card {
    background: #fff;
    border-radius: 16px;
    padding: 25px;
    border-left: 6px solid #dc3545;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    animation: fadeIn .3s ease-out;
}

.card-header {
    display:flex;
    justify-content:space-between;
    margin-bottom: 12px;
}

.announcement-title {
    font-size: 1.3rem;
    font-weight: 700;
    color:#dc3545;
}

/* ———————– MODAL ———————– */
.modal-overlay {
    display:none;
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background: rgba(0,0,0,0.6);
    justify-content:center;
    align-items:center;
    z-index:1000;
}

.modal-content {
    background:#fff;
    padding: 35px;
    border-radius:18px;
    width:500px;
    max-width:90%;
    max-height:85vh;
    overflow-y:auto;
}

</style>

<div class="announcements-container">

    <!-- HEADER -->
    <header class="announcements-header">
        <div class="header-left">
            {% if is_admin %}
            <a href="{% url 'admin_menu' %}" class="back-button">
                <i class="fas fa-arrow-left"></i>
            </a>
            {% else %}
            <a href="{% url 'main_menu' %}" class="back-button">
                <i class="fas fa-arrow-left"></i>
            </a>
            {% endif %}
            <h1 class="header-title">Official Announcements</h1>
        </div>

        {% if is_admin %}
        <div style="display:flex; gap:12px;">
            <!-- NEW ARCHIVED POSTS BUTTON -->
            <a href="{% url 'archived_announcements' %}"
               class="gray-btn">
                <i class="fas fa-archive"></i> Archived Posts
            </a>

            <!-- NEW POST BUTTON -->
            <button onclick="document.getElementById('addPostModal').style.display='flex'"
                    class="green-btn">
                <i class="fas fa-plus-circle"></i> Add New Post
            </button>
        </div>
        {% endif %}
    </header>

    <!-- MESSAGES -->
    {% if messages %}
    {% for message in messages %}
    <div style="margin:20px; padding:18px;
        border-radius:12px;
        font-weight:600;
        text-align:center;
        background: {% if 'success' in message.tags %}#d4edda{% else %}#f8d7da{% endif %};
        color: {% if 'success' in message.tags %}#155724{% else %}#721c24{% endif %};
        border: 2px solid {% if 'success' in message.tags %}#28a745{% else %}#dc3545{% endif %};">
        {{ message }}
    </div>
    {% endfor %}
    {% endif %}

    <!-- MAIN CONTENT -->
    <main style="padding:35px; background:#f8f9fa;">

        <div class="announcements-grid" style="
            display:grid;
            grid-template-columns:repeat(auto-fill,minmax(450px,1fr));
            gap:25px;">

            {% for post in announcements %}
            <div class="announcement-card">

                <div class="card-header">
                    <h3 class="announcement-title">{{ post.title }}</h3>

                    <span style="
                        background:#e8ecf4;
                        padding:6px 12px;
                        border-radius:20px;
                        font-size:.85rem;
                        color:#2c3e50;">
                        <i class="far fa-calendar-alt"></i>
                        {{ post.date_posted|date:"M j, Y" }}
                    </span>
                </div>

                <p style="color:#2c3e50; line-height:1.6;">{{ post.content }}</p>

                <div style="
                    margin-top:18px;
                    display:flex;
                    justify-content:space-between;
                    align-items:center;
                    padding-top:15px;
                    border-top:2px solid #e8ecf4;">

                    <span style="color:#7c8db5; font-size:.85rem;">
                        <i class="far fa-clock"></i>
                        Posted {{ post.date_posted|timesince }} ago
                    </span>

                    {% if is_admin %}
                    <div style="display:flex; gap:10px;">

                        <!-- EDIT BUTTON -->
                        <button onclick="confirmEdit('{{ post.id }}')"
                                class="green-btn"
                                style="padding:10px 14px;">
                            <i class="fas fa-edit"></i> Edit
                        </button>

                        <!-- ARCHIVE BUTTON -->
                        <button onclick="confirmArchive('{{ post.id }}')"
                                class="gray-btn"
                                style="padding:10px 16px; background: #6c757d;">
                            <i class="fas fa-archive"></i> Archive
                        </button>

                        <!-- HIDDEN FORMS -->
                        <form id="edit-form-{{ post.id }}" action="{% url 'edit_post' post.id %}" method="get"></form>

                        <form id="archive-form-{{ post.id }}"
                              action="{% url 'archive_post' post.id %}"
                              method="post"
                              style="display:none;">
                            {% csrf_token %}
                        </form>

                    </div>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div style="
                text-align:center;
                padding:60px;
                grid-column:1/-1;">
                <i class="fas fa-inbox" style="font-size:4rem; color:#dee2e6;"></i>
                <p style="font-size:1.3rem; color:#777;">No announcements yet.</p>
            </div>
            {% endfor %}
        </div>
    </main>
</div>

<!-- ADD POST MODAL -->
{% if is_admin %}
<div id="addPostModal" class="modal-overlay">
    <div class="modal-content">

        <h2 style="margin-bottom:20px; color:#dc3545;">New Announcement</h2>

        <form action="{% url 'add_post' %}" method="post">
            {% csrf_token %}

            <label>Title</label>
            <input type="text" name="title"
                   required
                   style="width:100%; padding:12px; margin-bottom:15px; border-radius:10px; border:2px solid #ddd;">

            <label>Content</label>
            <textarea name="content"
                      required
                      style="width:100%; padding:12px; height:120px; border-radius:10px; border:2px solid #ddd;"></textarea>

            <div style="margin-top:20px; display:flex; justify-content:flex-end; gap:10px;">
                <button type="button"
                        class="gray-btn"
                        onclick="document.getElementById('addPostModal').style.display='none'">
                    Cancel
                </button>

                <button type="submit" class="green-btn">
                    <i class="fas fa-paper-plane"></i> Submit
                </button>
            </div>
        </form>
    </div>
</div>
{% endif %}

<!-- JS -->
<script>
function confirmEdit(id) {
    Swal.fire({
        title: "Edit Announcement?",
        icon: "question",
        showCancelButton: true,
        confirmButtonColor: "#28a745",
    }).then(res => {
        if(res.isConfirmed) document.getElementById("edit-form-"+id).submit();
    });
}

function confirmArchive(id) {
    Swal.fire({
        title: "Archive Announcement?",
        text: "This will move the post to archived announcements.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#6c757d",
    }).then(res => {
        if(res.isConfirmed) document.getElementById("archive-form-"+id).submit();
    });
}

window.onclick = function(e) {
    const modal = document.getElementById('addPostModal');
    if (e.target === modal) modal.style.display = "none";
};
</script>

{% endblock %}
