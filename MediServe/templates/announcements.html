{% extends 'base.html' %}
{% load static %}

{% block title %}Barangay Announcements{% endblock %}

{% block content %}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>

/* ———————– MAIN CONTAINER ———————– */
.announcements-container {
    width: 100%;
    max-width: 1400px;
    margin: 40px auto;
    background: #ffffff;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
}

/* ———————– HEADER ———————– */
.announcements-header {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    padding: 30px 40px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.header-left { display: flex; align-items: center; gap: 15px; }

.back-button {
    padding: 12px;
    background-color: rgba(255,255,255,0.2);
    border-radius: 12px;
    color: #fff;
    width: 48px;
    height: 48px;
    display:flex;
    justify-content:center;
    align-items:center;
    border: 2px solid rgba(255,255,255,0.3);
    text-decoration: none;
}

.header-title {
    font-size: 1.8rem;
    font-weight: 700;
    color: #fff;
}

/* ———————– BUTTONS ———————– */
.green-btn, .gray-btn {
    padding: 14px 22px;
    border-radius: 12px;
    color: #fff;
    font-weight: 600;
    cursor: pointer;
    border: none;
    display:flex;
    align-items:center;
    gap: 8px;
    text-decoration: none;
}

.green-btn { background: linear-gradient(135deg, #28a745, #20c997); }
.gray-btn { background: linear-gradient(135deg, #6c757d, #495057); }

/* ———————– ANNOUNCEMENT CARDS ———————– */
.announcement-card {
    background: #fff;
    border-radius: 16px;
    padding: 25px;
    border-left: 6px solid #dc3545;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    animation: fadeIn .3s ease-out;

    cursor:pointer;
    transition: all .2s ease;
}

.announcement-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 26px rgba(0,0,0,0.12);
}

.card-header { display:flex; justify-content:space-between; margin-bottom: 12px; }

.announcement-title {
    font-size: 1.3rem;
    font-weight: 700;
    color:#dc3545;
}

/* PREVIEW */
.announcement-preview {
    color:#2c3e50;
    line-height:1.6;
}

/* ———————– SEE MORE BUTTON ———————– */
.see-more-btn {
    background:none;
    border:none;
    color:#dc3545;
    cursor:pointer;
    font-weight:600;
    margin-top:10px;
}
.see-more-btn:hover { text-decoration: underline; }

/* ———————– MODERN MODAL ———————– */
.modal-overlay {
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.6);
    display:none;
    justify-content:center;
    align-items:center;
    z-index:2000;
}

.modal-content {
    background:#fff;
    padding:35px 40px;
    border-radius:18px;
    width:650px;
    max-width:90%;
    max-height:80vh;
    overflow-y:auto;
    box-shadow: 0 10px 40px rgba(0,0,0,0.25);
    animation: fadeIn .25s ease-out;
}

.modal-title {
    font-size:1.8rem;
    font-weight:700;
    color:#dc3545;
    margin-bottom:15px;
}

.modal-body {
    font-size:1rem;
    line-height:1.65;
    white-space:normal;
    color:#2c3e50;
}

@keyframes fadeIn {
    from { opacity:0; transform:scale(0.95); }
    to   { opacity:1;   transform:scale(1);   }
}

</style>

<div class="announcements-container">

    <!-- HEADER -->
    <header class="announcements-header">
        <div class="header-left">
            {% if is_admin %}
            <a href="{% url 'admin_menu' %}" class="back-button"><i class="fas fa-arrow-left"></i></a>
            {% else %}
            <a href="{% url 'main_menu' %}" class="back-button"><i class="fas fa-arrow-left"></i></a>
            {% endif %}
            <h1 class="header-title">Official Announcements</h1>
        </div>

        {% if is_admin %}
        <div style="display:flex; gap:12px;">
            <a href="{% url 'archived_announcements' %}" class="gray-btn">
                <i class="fas fa-archive"></i> Archived Posts
            </a>

            <button onclick="document.getElementById('addPostModal').style.display='flex'" class="green-btn">
                <i class="fas fa-plus-circle"></i> Add New Post
            </button>
        </div>
        {% endif %}
    </header>

    <!-- MESSAGES -->
    {% if messages %}
    {% for message in messages %}
    <div style="margin:20px; padding:18px;
        border-radius:12px; font-weight:600; text-align:center;
        background: {% if 'success' in message.tags %}#d4edda{% else %}#f8d7da{% endif %};
        color: {% if 'success' in message.tags %}#155724{% else %}#721c24{% endif %};
        border: 2px solid {% if 'success' in message.tags %}#28a745{% else %}#dc3545{% endif %};">
        {{ message }}
    </div>
    {% endfor %}
    {% endif %}

    <!-- MAIN CONTENT -->
    <main style="padding:35px; background:#f8f9fa;">

        <div class="announcements-grid"
             style="display:grid; grid-template-columns:repeat(auto-fill,minmax(450px,1fr)); gap:25px;">

            {% for post in announcements %}
            <div class="announcement-card"
                 data-title="{{ post.title }}"
                 data-content="{{ post.content }}">

                <div class="card-header">
                    <h3 class="announcement-title">{{ post.title }}</h3>

                    <span style="background:#e8ecf4; padding:6px 12px; border-radius:20px; font-size:.85rem; color:#2c3e50;">
                        <i class="far fa-calendar-alt"></i> {{ post.date_posted|date:"M j, Y" }}
                    </span>
                </div>

                <p class="announcement-preview">{{ post.content|truncatechars:180 }}</p>

                <button class="see-more-btn"
                        data-title="{{ post.title }}"
                        data-content="{{ post.content }}">
                    See More
                </button>

                <div style="margin-top:18px; display:flex; justify-content:space-between;
                            align-items:center; padding-top:15px; border-top:2px solid #e8ecf4;">

                    <span style="color:#7c8db5; font-size:.85rem;">
                        <i class="far fa-clock"></i> Posted {{ post.date_posted|timesince }} ago
                    </span>

                    {% if is_admin %}
                    <div style="display:flex; gap:10px;">

                        <button onclick="confirmEdit('{{ post.id }}')" class="green-btn" style="padding:10px 14px;">
                            <i class="fas fa-edit"></i> Edit
                        </button>

                        <button onclick="confirmArchive('{{ post.id }}')" class="gray-btn" style="padding:10px 16px;">
                            <i class="fas fa-archive"></i> Archive
                        </button>

                        <form id="edit-form-{{ post.id }}" action="{% url 'edit_post' post.id %}" method="get"></form>

                        <form id="archive-form-{{ post.id }}" action="{% url 'archive_post' post.id %}"
                              method="post" style="display:none;">
                            {% csrf_token %}
                        </form>

                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}

        </div>
    </main>
</div>


<!-- ———————– VIEW FULL ANNOUNCEMENT MODAL ———————– -->
<div id="viewAnnouncementModal" class="modal-overlay">
    <div class="modal-content">
        <h2 id="modalTitle" class="modal-title"></h2>
        <div id="modalBody" class="modal-body"></div>

        <div style="margin-top:20px; display:flex; justify-content:flex-end;">
            <button class="gray-btn close-modal">Close</button>
        </div>
    </div>
</div>


<!-- ———————– ADD POST MODAL ———————– -->
{% if is_admin %}
<div id="addPostModal" class="modal-overlay">
    <div class="modal-content">

        <h2 style="color:#dc3545; margin-bottom:20px;">New Announcement</h2>

        <form action="{% url 'add_post' %}" method="post">
            {% csrf_token %}

            <label>Title</label>
            <input type="text" name="title" required
                   style="width:100%; padding:12px; margin-bottom:15px; border-radius:10px; border:2px solid #ddd;">

            <label>Content</label>
            <textarea name="content" required
                      style="width:100%; padding:12px; height:120px; border-radius:10px; border:2px solid #ddd;"></textarea>

            <div style="margin-top:20px; display:flex; justify-content:flex-end; gap:10px;">
                <button type="button" class="gray-btn"
                        onclick="document.getElementById('addPostModal').style.display='none'">Cancel</button>

                <button type="submit" class="green-btn">
                    <i class="fas fa-paper-plane"></i> Submit
                </button>
            </div>
        </form>
    </div>
</div>
{% endif %}


<script>

/* ———————– CLICKABLE CARD + SEE MORE ———————– */
const modal = document.getElementById("viewAnnouncementModal");
const modalTitle = document.getElementById("modalTitle");
const modalBody = document.getElementById("modalBody");
const closeModalBtn = document.querySelector(".close-modal");

document.querySelectorAll(".see-more-btn, .announcement-card").forEach(item => {
    item.addEventListener("click", function (e) {

        // Prevent card click when clicking edit/archive buttons
        if (e.target.closest(".green-btn") || e.target.closest(".gray-btn")) return;

        const title = this.dataset.title;
        const content = this.dataset.content;

        modalTitle.innerText = title;

        // FIX — restores line breaks and removes \u000D\u000A
        modalBody.innerHTML = content.replace(/(?:\r\n|\r|\n)/g, "<br>");

        modal.style.display = "flex";
    });
});

closeModalBtn.addEventListener("click", () => modal.style.display = "none");

modal.addEventListener("click", (e) => {
    if (e.target === modal) modal.style.display = "none";
});


/* ———————– EXISTING ADMIN ACTIONS ———————– */
function confirmEdit(id) {
    Swal.fire({
        title: "Edit Announcement?",
        icon: "question",
        showCancelButton: true,
        confirmButtonColor: "#28a745",
    }).then(res => {
        if(res.isConfirmed) document.getElementById("edit-form-"+id).submit();
    });
}

function confirmArchive(id) {
    Swal.fire({
        title: "Archive Announcement?",
        text: "This will move the post to archived announcements.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#6c757d",
    }).then(res => {
        if(res.isConfirmed) document.getElementById("archive-form-"+id).submit();
    });
}

</script>

{% endblock %}
